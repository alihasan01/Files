<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Concurrency Control - iModel.js</title>
    <meta name="og:title" content="Concurrency Control - iModel.js">
    <meta name="twitter:title" content="Concurrency Control - iModel.js">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" type="text/css" href="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/styles/bundle.css">

    <!-- bootstrap -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>

    <!-- fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet"> 
    
    <link rel="stylesheet" type="text/css" href="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/styles/landingPage.css"> 
    
    <link rel="stylesheet" type="text/css" href="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/styles/devRegistration.css">  
        <link rel='shortcut icon' type='image/x-icon' href='http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/landing-page/assets/imodeljs_16.png' /> 
        <meta property="og:description" content="Create Immersive Connections with your Infrastructure Digital Twin."><meta property="og:url" content="imodeljs.org"><meta name="twitter:card" content="summary_large_image">
        <meta property="og:image" content="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/landing-page/assets/twitter-share.png">
        <meta />
</head>

<body data-site-root=http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/ class='layout-index '>
    <span id="contentLoader">
        <p>Woah! This page has a great deal of content... Give us a second to load it.</p>
    </span>
    <span id="contentLoaderBackground"></span>
    <div id="flex-wrapper">



        <header id="main-header">
            <div class='nav-header-container'>
                <nav class="navbar nav-main-header navbar-expand-md fixed-top navbar-light pb-0">
                    <a href="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/" class="navbar-brand">
                            <img id="site-logo" class="site-logo" src="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/landing-page/assets/imodeljs-logo.svg" /> 
                            <img id="site-logo-small" class="site-logo-small" src="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/landing-page/assets/imodeljs-icon.svg" style="display:none;"/> 
                    </a>
                    <button class="navbar-toggler no-user-select mr-auto" type="button" data-toggle="collapse" data-target="#navbar5">
                        <span class="navbar-toggler-header"></span>
                    </button>
                    <ul class="navbar-nav ml-auto pr-0 nav-search">
                        <span class='search-bar'>
                          <li>
                            <div id='search-container'>
                            </div>
                          </li>
                          <script>
                            (function() {
                              var cx = '018053174497532353467:v_gnrjjlqwc';
                              var gcse = document.createElement('script');
                              gcse.type = 'text/javascript';
                              gcse.async = true;
                              gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
                              var s = document.getElementsByTagName('script')[0];
                              s.parentNode.insertBefore(gcse, s);
                            })();
                          </script>
                          <gcse:searchresults-only gname="sitesearch" resultSetSize="7"></gcse:search>
                        </span>
                    </ul>
                    <div class="navbar-collapse collapse justify-content-stretch" id="navbar5">
                        <ul class="navbar-nav mb-0" id="doc-site-tabs">
                                <li class="nav-item "><a class="nav-link" href="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/getting-started">Getting Started</a></li><li class="nav-item "><a class="nav-link" href="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/bis">BIS</a></li><li class="nav-item active"><a class="nav-link" href="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/learning">Learning</a></li><li class="nav-item "><a class="nav-link" href="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/reference">API Reference</a></li><li class="nav-item change-history-tab "><a class="nav-link" href="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/changehistory">v0.190.0</a></li>
                        </ul>
                    </div>
                </nav>
            </div>
        </header>
<div id='main-wrapper'>
    <nav id='sidebar'>
        <div id='table-of-contents' class="custom-scrollbar">
            <div id="dismiss">
                <i id="dismiss-arrow" class="icon icon-chevron-left no-user-select"></i>
            </div>
            <hr id="dismiss-hr" class='sm-only'>
            <ul id='main-navigation-list'>
                <html><head></head><body><h3 id="the imodel.js library"><a href="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/learning/" class="table-of-contents-link">The iModel.js Library</a></h3>
    <ul>
    <li><a href="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/learning/frontend/" class="table-of-contents-link">Frontend</a></li>
    <li><a href="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/learning/backend/" class="table-of-contents-link">Backend</a></li>
    <li><a href="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/learning/common/" class="table-of-contents-link">Common</a></li>
    <li><a href="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/learning/geometry/" class="table-of-contents-link">Geometry</a></li>
    </ul>
    <hr>
    <p>&#xA0;</p>
    <h3 id="helpful links">Helpful links</h3>
    <ul>
    <li><a href="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/./learning/ecsql" class="table-of-contents-link">ECSQL</a></li>
    <li><a href="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/learning/imodelhub/" class="table-of-contents-link">iModelHub</a></li>
    <li><a href="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/./learning/wireformat" class="table-of-contents-link">Wire Format</a></li>
    <li><a href="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/./learning/faq" class="table-of-contents-link">Frequently Asked Questions</a></li>
    <li><a href="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/learning/guidelines/" class="table-of-contents-link">Guidelines and Tips</a></li>
    <li><a href="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/./learning/glossary" class="table-of-contents-link">iModel.js Glossary</a></li>
    </ul>
    </body></html>
            </ul>
        </div>
    </nav>    <div class='documentation-main'>
        <article id="main" class="main-content">
            <button type="button" id="sidebarCollapse" class="no-user-select"> <i class="bread-crumb-label bread-crumb-expand-leftnav icon icon-chevron-right no-user-select" id="expand-leftnav"></i></button><div class='bread-crumb-label'><a href="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/learning/">Learning</a> > <a href="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/learning/backend/">backend</a> > ConcurrencyControl</div>
            <div class="edit-link"><a href="https://bentleycs.visualstudio.com/iModelTechnologies/iModelTechnologies/_git/imodeljs?path=/docs/core/learning%2Fbackend%2FConcurrencyControl.md" target="_blank">Edit this page</a></div>
            <h1 id="concurrency control">Concurrency Control</h1>
<p>Concurrency control is a way to coordinate simultaneous transactions (briefcases) while preserving data integrity. Concurrency control is implemented in the code of an app and is based on the identity of a briefcase. Concurrency control should not to be confused with user access control. To make coordinated changes, an app must follow 3 basic rules:</p>
<ol>
<li><a href="#code-reservation">Reserve Codes</a> before using them.</li>
<li>Optionally lock models and elements before modifying them, depending on the iModel&apos;s <a href="#concurrency-control-policies">concurrency control policy</a></li>
<li><a href='http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/./learning/backend/imodeldbsync'>Pull and merge</a> before pushing.</li>
</ol>
<p>An iModel has a concurrency control policy that specifies how multiple briefcases may modify models and elements. The policy may stipulate that locks must be used, forcing transactions to be sequential (pessimistic), or it may specify change-merging with conflict-resolution to combine the results of simultaneous transactions (optimistic).</p>
<p>An app uses <a href='http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/./reference/imodeljs-backend/imodels/imodeldb'>IModelDb</a> and <a href='http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/./reference/imodeljs-backend/imodels/concurrencycontrol'>ConcurrencyControl</a> to follow concurrency control rules.</p>
<p>Locks and code reservations are associated with a briefcase while it is making changes and are released when it pushes.</p>
<h2 class="h-background">Background<a id="background" class="heading-anchor" href="#background"><span><i class="fa fa-link fa-rotate-90"></i></span></a></h2>
<p>This article assumes that you already know that:</p>
<ul>
<li>An iModel is a multi-user database</li>
<li>An app works with a <a href='http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/./learning/glossary/#briefcase'>briefcase</a> using the <a href='http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/./reference/imodeljs-backend/imodels/imodeldb'>IModelDb</a> class.</li>
<li>A briefcase has a unique identity that is issued and tracked by <a href='http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/learning/imodelhub/'>iModelHub</a>.</li>
<li>Changes are captured and distributed in the form of <a href='http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/./learning/imodelhub/briefcases'>ChangeSets</a>.</li>
<li>ChangeSets are ordered in a sequence that is called the <a href='http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/learning/imodelhub//#the-timeline-of-changes-to-an-imodel'>timeline</a> of the iModel.</li>
<li>ChangeSets are stored in iModelHub</li>
<li>A <a href='http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/./learning/glossary/#code'>Code</a> is an identifier that is assigned to an element and is managed by a central Code Service.</li>
</ul>
<h2 class="h-concurrency-glossary">Concurrency Glossary<a id="concurrency-glossary" class="heading-anchor" href="#concurrency-glossary"><span><i class="fa fa-link fa-rotate-90"></i></span></a></h2>
<table class="table table-responsive"><tbody><tr>
<th>Term</th>
<th>Definition</th>
</tr>
<tr>
<td><strong>Base</strong></td>
<td>ChangeSet B is <em>based</em> on ChangeSet A if B comes after A in the timeline.</td>
</tr>
<tr>
<td><strong>Change-merging</strong></td>
<td>Same as merge.</td>
</tr>
<tr>
<td><strong>Code Reservation</strong></td>
<td>The right to use a Code</td>
</tr>
<tr>
<td><strong>Concurrency Control</strong></td>
<td>How to coordinate simultaneous transactions while preserving data integrity.</td>
</tr>
<tr>
<td><strong>Concurrency Control Policy</strong></td>
<td>The rules that apps must follow when changing models and elements. May be <a href="#optimistic-concurrency-control">optimistic</a> or <a href="#pessimistic-concurrency-control">pessimistic</a>.</td>
</tr>
<tr>
<td><strong>Conflict</strong></td>
<td>Arises when two ChangeSets change the same object in different ways, where neither ChangeSet is based on the other.</td>
</tr>
<tr>
<td><strong>Conflict-resolution</strong></td>
<td>Choosing how to resolve a conflict.</td>
</tr>
<tr>
<td><strong>Lock</strong></td>
<td>The right to access a specific type of data with specific sharing permissions.</td>
</tr>
<tr>
<td><strong>Merge</strong></td>
<td>Apply a ChangeSet to a briefcase.</td>
</tr>
<tr>
<td><strong>Optimistic Concurrency Control</strong></td>
<td>A policy that allows apps to change models and elements without acquiring locks.</td>
</tr>
<tr>
<td><strong>Pessimistic Concurrency Control</strong></td>
<td>A policy that requires apps to acquire locks before changing models or elements.</td>
</tr>
<tr>
<td><strong>Push</strong></td>
<td>Upload a ChangeSet to iModelHub</td>
</tr>
<tr>
<td><strong>Pull</strong></td>
<td>Download a ChangeSet from iModelHub. See <a href='http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/./learning/backend/imodeldbsync'>IModelDb synchronization</a></td>
</tr>
<tr>
<td><strong>Rebase</strong></td>
<td>Adjust a ChangeSet so that its pre-change state matches the post-change state of some other ChangeSet.</td>
</tr>
<tr>
<td><strong>Tip</strong></td>
<td>The most recent version of an iModel. Also, the most recent ChangeSet in the timeline.</td>
</tr>
<tr>
<td><strong>Transaction</strong></td>
<td>A set of changes that are committed or abandoned atomically, making up a unit of work. Multiple transactions to a briefcase are combined into a <a href='http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/./learning/glossary/#changeset'>ChangeSet</a>.</td>
</tr>
<tr>
<td><strong>Version</strong></td>
<td>The state of an iModel as of a specific point in its timeline, that is, the result of the ChangeSets up to that point.</td>
</tr>
</tbody></table><h2 class="h-code-reservation">Code Reservation<a id="code-reservation" class="heading-anchor" href="#code-reservation"><span><i class="fa fa-link fa-rotate-90"></i></span></a></h2>
<p>An app must reserve all Codes that it plans to assign to elements during a local editing session. An app can reserve more Codes than it actually uses. For example, an app may reserve a range or block of Codes in a sequence to ensure that it can use them, but before it knows exactly how many it will need. When the local ChangeSet is finally pushed, the Code Service sorts out which reserved Codes were actually used and which were not. Unused Codes are returned to the pool, while used Codes are marked as used and unavailable. When an element is deleted, its Code may be returned to the pool.</p>
<p>See <a href="#how-to-acquire-locks-and-reserve-codes">below</a> for how to reserve codes.</p>
<!-- TODO: Check if the Code of a deleted element becomes available for assignment to another element or not. -->
<p>The optimistic concurrency control policy does not apply to Codes.</p>
<h2 class="h-concurrency-control-policies">Concurrency Control Policies<a id="concurrency-control-policies" class="heading-anchor" href="#concurrency-control-policies"><span><i class="fa fa-link fa-rotate-90"></i></span></a></h2>
<p>Preemptive locking is always required when importing Schemas or changing or inserting CodeSpecs. The APIs for those objects take care of locking automatically, so there is nothing special for an app to do.</p>
<p>For models and elements, there are two locking policy options: pessimistic and optimistic. The <a href='http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/./reference/imodeljs-backend/imodels/concurrencycontrol'>ConcurrencyControl</a> class specifies the concurrency control policy for an iModel. The app must check the <code>iModelDb.concurrencyControl</code> property to learn the policy and then implement it.</p>
<h3 class="h-pessimistic-concurrency-control">Pessimistic Concurrency Control<a id="pessimistic-concurrency-control" class="heading-anchor" href="#pessimistic-concurrency-control"><span><i class="fa fa-link fa-rotate-90"></i></span></a></h3>
<p> To set up an iModel to use the pessimistic concurrency control policy, specify the ConcurrencyControl.PessimisticPolicy, as follows:</p>
<pre class="no-line-numbers"><code class="language-typescript">     iModel.concurrencyControl.setPolicy(new ConcurrencyControl.PessimisticPolicy());</code></pre>
<p>The pessimistic concurrency policy requires that models and elements must be locked before local changes can be pushed to iModelHub. Locking prevents concurrent changes and forces briefcase transactions affecting the same models and elements to be sequential.</p>
<p>For reference, the pessimistic locking rules are as follows:</p>
<table class="table table-responsive"><tbody><tr>
<th>Operation</th>
<th>LockType</th>
<th>Lock Level</th>
</tr>
<tr>
<td>Insert element</td>
<td>Model</td>
<td>Shared</td>
</tr>
<tr>
<td>Modify element</td>
<td>Element</td>
<td>Exclusive</td>
</tr>
<tr>
<td>Delete element</td>
<td>Element</td>
<td>Exclusive</td>
</tr>
<tr>
<td>Insert model</td>
<td>DgnDb</td>
<td>Shared</td>
</tr>
<tr>
<td>Modify model</td>
<td>Model</td>
<td>Exclusive</td>
</tr>
<tr>
<td>Delete model</td>
<td>Model</td>
<td>Exclusive</td>
</tr>
<tr>
<td>&quot;</td>
<td>Elements in model</td>
<td>Exclusive</td>
</tr>
</tbody></table><p>An app will normally implement the pessimistic policy by using high-level APIs to build lock requests based on the intended operation, as explained <a href="#how-to-acquire-locks-and-reserve-codes">below</a>. These high-level APIs take care of both acquiring locks and reserving Codes.</p>
<p>A briefcase must pull before it can lock an element or model if it is affected by a recently pushed ChangeSet.</p>
<p>An app that implements the pessimistic concurrency control policy follows the pull -&gt; lock -&gt; change -&gt; push pattern.</p>
<p> <img src=".././PessimisticConcurrencyControl.jpg" alt="pessimistic concurrency example workflow"></p>
<p>Locks are normally released when the briefcase pushes its changes, or they may be released if the briefcase abandons its changes.</p>
<h3 class="h-optimistic-concurrency-control">Optimistic Concurrency Control<a id="optimistic-concurrency-control" class="heading-anchor" href="#optimistic-concurrency-control"><span><i class="fa fa-link fa-rotate-90"></i></span></a></h3>
<p> To set up an iModel to use optimistic concurrency control, specify the ConcurrencyControl.OptimisticPolicy, as follows:</p>
<pre class="no-line-numbers"><code class="language-typescript">     iModel.concurrencyControl.setPolicy(new ConcurrencyControl.OptimisticPolicy());</code></pre>
<p> An optimistic concurrency policy allows apps to modify elements and models in an iModel without acquiring locks. In this case, the app uses change-merging to reconcile local changes before pushing.</p>
<p> Working without locks opens up the possibility that other apps may add ChangeSets to the timeline while the local editing session is in progress. The briefcase must then merge before it can push.</p>
<p> Suppose, for example, that two briefcases were editing different properties of the same element at the same time. Suppose that the first briefcase pushed first, creating ChangeSet#1. Now, the second briefcase must pull and merge before it can push.</p>
<p> <img src=".././OptimisticConcurrencyControl.jpg" alt="optimistic concurrency example workflow"></p>
<h4 class="h-conflicts">Conflicts<a id="conflicts" class="heading-anchor" href="#conflicts"><span><i class="fa fa-link fa-rotate-90"></i></span></a></h4>
<p> Working without locks also opens up the possibility that local changes may overlap with in-coming ChangeSets. When ChangeSets are merged into the briefcase, the change-merging algorithm checks for conflicts. The algorithm merges changes and checks for conflicts at the level of individual element properties. In the example above, the two briefcases changed different properties of the same element. That is not a conflict. Likewise, it is not a conflict for two briefcases both to set a property to the same value, or for two briefcases both to delete an element. Conflicts arise if the two briefcases set the same property to different values, or if one briefcase modifies a property and the other deletes the element.</p>
<p> If conflicts are found, the change-merging algorithm applies the iModel&apos;s conflict-resolution policy. This can be accessed using the <a href='http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/./reference/imodeljs-backend/imodels/imodeldb/concurrencycontrol'>IModelDb.concurrencyControl</a> property. The policy object includes a <a href='http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/./reference/imodeljs-backend/imodels/concurrencycontrol.conflictresolutionpolicy'>ConcurrencyControl.ConflictResolutionPolicy</a> that specifies a conflict-handling policy for each combination of changes that could conflict. The handling operations are defined by <a href='http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/./reference/imodeljs-backend/imodels/concurrencycontrol.onconflict'>ConcurrencyControl.OnConflict</a>. The default conflict-resolution policies are:</p>
<table class="table table-responsive"><tbody><tr>
<th>Local Change</th>
<th>RemoteChange</th>
<th>Resolution</th>
</tr>
<tr>
<td>update</td>
<td>update</td>
<td>RejectIncomingChange</td>
</tr>
<tr>
<td>update</td>
<td>delete</td>
<td>AcceptIncomingChange (reject not support)</td>
</tr>
<tr>
<td>delete</td>
<td>update</td>
<td>RejectIncomingChange (accept not supported)</td>
</tr>
</tbody></table><p> Property-level change-merging is very fine-grained, and so it allows many kinds of changes to be made simultaneously without conflicts. A schema may also specify rules to check for conflicts on a higher level.
 <!-- TBD: Link to ElementDrivesElement --></p>
<p> Only models and elements may be changed optimistically. Locking is required when importing Schemas or changing or inserting CodeSpecs.</p>
<h2 class="h-how-to-acquire-locks-and-reserve-codes">How to Acquire Locks and Reserve Codes<a id="how-to-acquire-locks-and-reserve-codes" class="heading-anchor" href="#how-to-acquire-locks-and-reserve-codes"><span><i class="fa fa-link fa-rotate-90"></i></span></a></h2>
<p>This section describes how an app reserves Codes and/or acquires locks. There are two options for when and how to do this during a local transaction: before making changes (preemptively) or after making changes (bulk mode).</p>
<h3 class="h-acquiring-locks-andor-codes-preemptively">Acquiring locks and/or codes preemptively<a id="acquiring-locks-andor-codes-preemptively" class="heading-anchor" href="#acquiring-locks-andor-codes-preemptively"><span><i class="fa fa-link fa-rotate-90"></i></span></a></h3>
<ol>
<li><p>Call <a href='http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/./reference/imodeljs-backend/models/model/buildconcurrencycontrolrequest'>Model.buildConcurrencyControlRequest</a> and <a href='http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/./reference/imodeljs-backend/elements/element/buildconcurrencycontrolrequest'>Element.buildConcurrencyControlRequest</a> to discover what locks and codes would be needed before making local changes.</p>
</li>
<li><p>Call <a href='http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/./reference/imodeljs-backend/imodels/concurrencycontrol/request'>ConcurrencyControl.request</a> to request the locks and/or codes that the planned local operations will require. This may send a request to iModelHub.</p>
</li>
<li>If the request fails, cancel the local operation.</li>
<li>If the request succeeds, go ahead with the local operation, make the planned local changes, and then call <a href='http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/./reference/imodeljs-backend/imodels/imodeldb/savechanges'>IModelDb.saveChanges</a>.</li>
</ol>
<p> This approach is the safest way to avoid conflicts. It requires that the app must plan ahead before making local changes.</p>
<p>Note that sending a request to iModelHub is a relatively expensive operation. Therefore it is important to batch up requests for locks and/or Codes.</p>
<h3 class="h-acquiring-locks-andor-codes-in-bulk-mode">Acquiring locks and/or codes in bulk mode<a id="acquiring-locks-andor-codes-in-bulk-mode" class="heading-anchor" href="#acquiring-locks-andor-codes-in-bulk-mode"><span><i class="fa fa-link fa-rotate-90"></i></span></a></h3>
<ol>
<li><p>Insert or update models and elements.</p>
</li>
<li><p>Call <a href='http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/./reference/imodeljs-backend/imodels/concurrencycontrol/request'>ConcurrencyControl.request</a> to request the locks and codes that those local operations require.</p>
</li>
<li>If the request fails, call <a href='http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/./reference/imodeljs-backend/imodels/imodeldb/#abandonchanges'>IModelDb.abandonChanges</a> to roll back the local transaction.</li>
<li><p>If the request succeeds, call <a href='http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/./reference/imodeljs-backend/imodels/imodeldb/savechanges'>IModelDb.saveChanges</a> to commit the local transaction.</p>
<p>Using bulk mode is simpler than using the preemptive approach, but it carries the risk that you must abandon all of your changes in case of a locking or code-reservation conflict. Use this approach only if you know that your changes are isolated such that conflicts are unlikely.</p>
</li>
</ol>
<h2 class="h-changesets-and-schema-changes">ChangeSets and Schema Changes<a id="changesets-and-schema-changes" class="heading-anchor" href="#changesets-and-schema-changes"><span><i class="fa fa-link fa-rotate-90"></i></span></a></h2>
<p>The special schema lock must be acquired before importing a schema into a briefcase. Also, schema changes must be isolated in a dedicated ChangeSet, separate from other kinds of changes. This is true for all concurrency control policies. To import a schema, an app must:</p>
<ol>
<li>Pull and merge to synchronize with the tip.</li>
<li>Push any local changes to iModelHub.</li>
<li>Perform the schema import in a local transaction.</li>
<li>Pull and merge to synchronize with the tip.</li>
<li>Push the results of the schema import as a ChangeSet to iModelHub.</li>
</ol>
<p>After applying a schema ChangeSet, the IModelDb must be closed and reopened.</p>

            <p class='last-updated'>Last Updated:
                <span class='date-updated'>08 May, 2019</span>
            </p>
            <div id="imodeljs-github-comments">
            </div>
            
            <script>
              $(document).ready(function () {
                function initializeComments(repo) {
                  var s = document.createElement('script');
                  s.src = "http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/scripts/utterances/client.js";
                  s.setAttribute('repo', repo);
                  s.setAttribute('issue-term', 'title');
                  s.setAttribute('crossorigin', 'anonymous');
                  s.setAttribute('theme', 'github-light');
                  s.async = true;
            
                  document.getElementById("imodeljs-github-comments").appendChild(s);
                }
            
                var shouldShow = ldclient.variation(featureFlags.GithubIssuesFeedback);
            
                // shouldShow is undefined when ldclient has not emitted 'ready'.
                if (shouldShow === undefined) {
                  ldclient.on('ready', function () {
                    var gitIssueFlag = ldclient.variation(featureFlags.GithubIssuesFeedback);
                    var gitRepo = ldclient.variation(featureFlags.GitRepo);
                    if (gitIssueFlag) {
                      initializeComments(gitRepo);
                    }
                  });
                }
                else if (shouldShow) {
                  var gitRepo = ldclient.variation(featureFlags.GitRepo);
                  initializeComments(gitRepo);
                }
              });
            </script>
            
            <script type="text/javascript">
            
            </script>        </article>
    </div>
    <div class="toc-overlay"></div>
    <div id='inner-table-of-contents'>
       <!-- <div id='sticky-container' style="top: 76px; position: fixed;">
  <h4 class='heading'>On this page</h4>
    <div id="overview-container" class="clusterize-scroll">
      <ul id='nav' class='right-nav nav flex-column clusterize-content'>
              <li class='nav-item item '>
            <a class='title solo-title menu-text' href="#background">Background</a>
    </li>
       <li class='nav-item item '>
            <a class='title solo-title menu-text' href="#concurrency-glossary">Concurrency Glossary</a>
    </li>
       <li class='nav-item item '>
            <a class='title solo-title menu-text' href="#code-reservation">Code Reservation</a>
    </li>
       <li class='nav-item item '>
            <a data-target="#inner-nav-concurrency-control-policies" class='title' href="#concurrency-control-policies"/>
            <b class='dropdown-menu-title menu-text'>Concurrency Control Policies</b>
            <i class='nav-list-dropdown icon'></i>
            </a>
            <ul id="inner-nav-concurrency-control-policies" class='inner-nav'>
                    <li class='nav-item item '>
                            <a class='title solo-title menu-text' href="#pessimistic-concurrency-control">Pessimistic Concurrency Control</a>
                    </li>
                    <li class='nav-item item '>
                            <a data-target="#inner-nav-optimistic-concurrency-control" class='title' href="#optimistic-concurrency-control"/>
                            <b class='dropdown-menu-title menu-text'>Optimistic Concurrency Control</b>
                            <i class='nav-list-dropdown icon'></i>
                            </a>
                            <ul id="inner-nav-optimistic-concurrency-control" class='inner-nav'>
                                    <li class='nav-item item '>
                                            <a class='title solo-title menu-text' href="#conflicts">Conflicts</a>
                                    </li>
                            </ul>
                    </li>
            </ul>
    </li>
       <li class='nav-item item '>
            <a data-target="#inner-nav-how-to-acquire-locks-and-reserve-codes" class='title' href="#how-to-acquire-locks-and-reserve-codes"/>
            <b class='dropdown-menu-title menu-text'>How to Acquire Locks and Reserve Codes</b>
            <i class='nav-list-dropdown icon'></i>
            </a>
            <ul id="inner-nav-how-to-acquire-locks-and-reserve-codes" class='inner-nav'>
                    <li class='nav-item item '>
                            <a class='title solo-title menu-text' href="#acquiring-locks-andor-codes-preemptively">Acquiring locks and/or codes preemptively</a>
                    </li>
                    <li class='nav-item item '>
                            <a class='title solo-title menu-text' href="#acquiring-locks-andor-codes-in-bulk-mode">Acquiring locks and/or codes in bulk mode</a>
                    </li>
            </ul>
    </li>
       <li class='nav-item item '>
            <a class='title solo-title menu-text' href="#changesets-and-schema-changes">ChangeSets and Schema Changes</a>
    </li>
 
      </ul>
    </div>
  </div>

 -->
    </div>
</div>

<!-- Footer -->
<footer class="page-footer font-small mdb-color pt-1 pb-3">
  <!-- Footer Links Container -->
  <div class="container text-center text-md-left">

    <!-- Grid row -->
    <div class="row d-flex align-items-center mt-2">

      <!-- Grid column -->
      <div class="col-md-7 col-lg-8 align-top d-none d-md-block">

        <a href="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/" class="navbar-brand">
          <img id="site-logo" class="site-logo" style="zoom:75%;"
            src="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/landing-page/assets/imodeljs-logo.svg" />
        </a>
        <small style="color: white; margin-right: 7px;"> powered by </small>
        <a href="https://www.bentley.com">
          <img href="https://www.bentley.com" id="sponsored-by-logo" class="sponsored-by-logo"
            style="zoom:75%; width: 162px; height: 37px;"
            src="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/landing-page/assets/bentley.svg" />
        </a>
      </div>
      <!-- Grid column -->

      <!-- Grid column -->
      <div class="col-md-5 col-lg-4 ml-lg-0">

        <!-- Social buttons -->
        <div class="text-center text-md-right">
          <ul class="list-unstyled list-inline">
            <li class="list-inline-item">
              <a class="btn-floating btn-sm rgba-white-slight mx-1" href="https://twitter.com/imodeljs" target="_blank">
                <i class="fa fa-twitter"></i>
              </a>
            </li>
            </li>
            <li class="list-inline-item">
              <a class="btn-floating btn-sm rgba-white-slight mx-1" href="https://github.com/imodeljs" target="_blank">
                <i class="fa fa-github"></i>
              </a>
            </li>
            <li class="list-inline-item">
              <a class="btn-floating btn-sm rgba-white-slight mx-1" href="https://stackoverflow.com/tags/imodeljs"
                target="_blank">
                <i class="fa fa-stack-overflow"></i>
              </a>
            </li>
          </ul>
        </div>

      </div>
      <!-- Grid column -->

    </div>
    <!-- Grid row -->

  </div>
  <!-- Footer Links Container -->

</footer>
<!-- Footer -->

</div>
<a href="javascript:" id="return-to-top"><i class="icon icon-chevron-up"></i></a>
<script src="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/scripts/bundle.js"></script>
</body>

</html>
<script src="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/scripts/monaco-editor/min/vs/loader.js"></script>
<script src="http://builds.bentley.com/prgbuilds/AzureBuilds/iModelJsDocs/public/scripts/ts-playground.js"></script>
